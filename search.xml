<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>5G SA Call Flow</title>
    <url>/2022/01/02/5G-SA-Call-Flow/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在核心網各網元E2E聯調時, 熟悉信令流程是查漏補缺必備的技能。</p>
<p>這篇文章將結合3GPP R15相關内容對5G SA信令流程進行簡單分析. </p>
<span id="more"></span>

<h2 id="5G-SA-注冊"><a href="#5G-SA-注冊" class="headerlink" title="5G SA 注冊"></a>5G SA 注冊</h2><p>下圖注冊流程截于23.502 </p>
<p><img src="/2022/01/02/5G-SA-Call-Flow/%E6%B3%A8%E5%86%8A%E6%B5%81%E7%A8%8B-R15.png"></p>
<h3 id="1-SA用戶UE打開手機嘗試進行數據連接的時候，首先是要發消息給基站RAN，麻煩RAN幫忙把UE的請求告訴給核心網吧。"><a href="#1-SA用戶UE打開手機嘗試進行數據連接的時候，首先是要發消息給基站RAN，麻煩RAN幫忙把UE的請求告訴給核心網吧。" class="headerlink" title="1. SA用戶UE打開手機嘗試進行數據連接的時候，首先是要發消息給基站RAN，麻煩RAN幫忙把UE的請求告訴給核心網吧。"></a>1. SA用戶UE打開手機嘗試進行數據連接的時候，首先是要發消息給基站RAN，麻煩RAN幫忙把UE的請求告訴給核心網吧。</h3><p>那既然UE想要被核心網接納， 就要傳遞一些信息，幫助核心網認定UE是白名單。 這裏3GPP定義了一些參數，是UE可能會携帶的。</p>
<p>下面參數截于23.502 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">AN message (AN parameters， Registration Request (Registration <span class="built_in">type</span>， SUCI or 5G-GUTI or PEI， last visited TAI (<span class="keyword">if</span> available)， Security parameters， Requested NSSAI， [Mapping Of Requested NSSAI]， Default </span><br><span class="line">Configured NSSAI Indication， UE Radio Capability Update， UE MM Core Network Capability， PDU Session status， List Of PDU Sessions To Be Activated， Follow-on request， MICO mode preference， Requested DRX </span><br><span class="line">parameters， [LADN DNN(s) or Indicator Of Requesting LADN Information]， [NAS message container]) and UE Policy Container (the list of PSIs， indication of UE support <span class="keyword">for</span> ANDSP and the operating system identifier)).</span><br></pre></td></tr></table></figure>

<p>官方文檔需要考慮多個場景，往往參數冗雜。 按照生活中的邏輯是， UE帶上來一個手機號碼就可以，與手機號相關的就是參數裏面的SUCI or 5G-GUTI。</p>
<p>在開卡時候，運營商會分配給用戶一個手機號，每個手機號碼會對應一個SUPI， 而SUCI就是UE通過ECIE-S scheme生成的，隨後携帶在消息中。 對於5G-GUTI，是UE第一次注冊之後，核心網給UE分配的一個標識。</p>
<p>這樣就可以延伸出兩個場景： UE第一次注冊和UE注冊完成后第二次注冊。</p>
<p>現在換個角度去核心網。 如果UE第一次注冊携帶SUCI， 核心網如果檢測到這個SUCI不合法，就可以不讓UE上網，如果檢測通過，則放行。 如果UE注冊携帶5G-GUTI，核心網則知道UE之前已經注冊過，可以去找之前的核心網網元拿UE信息。</p>
<p>當然，實際上判斷邏輯比這個複雜。如果UE携帶了Requested NSSAI，核心網則不止判斷UE號碼，而是會同時判斷NSSAI的值。</p>
<p>下面參數解釋截于23.501 &amp; 23.503</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PEI Permanent Equipment Identifier</span><br><span class="line"></span><br><span class="line">DNN Data Network Name </span><br><span class="line"></span><br><span class="line">LADN Local Area Data Network </span><br><span class="line"></span><br><span class="line">DRX Discontinuous Reception</span><br><span class="line"></span><br><span class="line">MICO Mobile Initiated Connection Only</span><br><span class="line"></span><br><span class="line">ANDSP Access Network Discovery &amp; Selection Policy </span><br></pre></td></tr></table></figure>

<h3 id="2-RAN收到消息說UE要幫忙后，就熱心的把消息轉給核心網。"><a href="#2-RAN收到消息說UE要幫忙后，就熱心的把消息轉給核心網。" class="headerlink" title="2. RAN收到消息說UE要幫忙后，就熱心的把消息轉給核心網。"></a>2. RAN收到消息說UE要幫忙后，就熱心的把消息轉給核心網。</h3><p>RAN對接的核心網網元在5G裏面叫AMF，他優先通過5G-GUTI裏蘊含的5G-S-TMSI和GUAMI信息找到合適的AMF。 那如果是SUCI呢，因爲RAN和AMF之間的N2接口基於SCTP,建立的時候是RAN測發起setup，所以RAN測會配置AMF的信息，可以從裏面根據優先級選擇對應的AMF。</p>
<p>關於5G-GUTI中5G-S-TMSI和GUAMI</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">5G-GUTI = GUAMI+ 5G-TMSI</span><br><span class="line"></span><br><span class="line">GUAMI = MCC+ MNC+ AMF Identifier</span><br><span class="line"></span><br><span class="line">AMF Identifier = AMF Region ID+ AMF Set ID+ AMF Pointer</span><br><span class="line"></span><br><span class="line">5G-S-TMSI = AMF Set ID+ AMF Pointer+ 5G-TMSI</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-RAN測找到合適的接頭AMF后，就會把UE的消息透傳給AMF。"><a href="#3-RAN測找到合適的接頭AMF后，就會把UE的消息透傳給AMF。" class="headerlink" title="3. RAN測找到合適的接頭AMF后，就會把UE的消息透傳給AMF。"></a>3. RAN測找到合適的接頭AMF后，就會把UE的消息透傳給AMF。</h3><p>同時，如果RAN是NG-RAN, 則會在UE消息基礎上加一些位置信息。</p>
<h3 id="4-Conditional-當從5G-GUTI得出UE之前是找其他的AMF辦理的注冊，則當前AMF去找之前的AMF了解情況。"><a href="#4-Conditional-當從5G-GUTI得出UE之前是找其他的AMF辦理的注冊，則當前AMF去找之前的AMF了解情況。" class="headerlink" title="4. [Conditional]當從5G-GUTI得出UE之前是找其他的AMF辦理的注冊，則當前AMF去找之前的AMF了解情況。"></a>4. [Conditional]當從5G-GUTI得出UE之前是找其他的AMF辦理的注冊，則當前AMF去找之前的AMF了解情況。</h3><h3 id="5-Conditional-如果舊的AMF有相應的UE信息，就會返回給當前的AMF。"><a href="#5-Conditional-如果舊的AMF有相應的UE信息，就會返回給當前的AMF。" class="headerlink" title="5. [Conditional]如果舊的AMF有相應的UE信息，就會返回給當前的AMF。"></a>5. [Conditional]如果舊的AMF有相應的UE信息，就會返回給當前的AMF。</h3><h3 id="6-Conditional-如果AMF無法根據5G-GUTI從當前或者舊的AMF獲取到SUCI-則應該發起request去要SUCI號碼。"><a href="#6-Conditional-如果AMF無法根據5G-GUTI從當前或者舊的AMF獲取到SUCI-則應該發起request去要SUCI號碼。" class="headerlink" title="6. [Conditional]如果AMF無法根據5G-GUTI從當前或者舊的AMF獲取到SUCI,則應該發起request去要SUCI號碼。"></a>6. [Conditional]如果AMF無法根據5G-GUTI從當前或者舊的AMF獲取到SUCI,則應該發起request去要SUCI號碼。</h3><h3 id="7-Conditional-既然核心網測要求了，UE就要回答。"><a href="#7-Conditional-既然核心網測要求了，UE就要回答。" class="headerlink" title="7. [Conditional]既然核心網測要求了，UE就要回答。"></a>7. [Conditional]既然核心網測要求了，UE就要回答。</h3><h3 id="8-AMF收到RAN這個中間人帶上來的消息後，打開看了一眼……"><a href="#8-AMF收到RAN這個中間人帶上來的消息後，打開看了一眼……" class="headerlink" title="8. AMF收到RAN這個中間人帶上來的消息後，打開看了一眼……"></a>8. AMF收到RAN這個中間人帶上來的消息後，打開看了一眼……</h3><p>AMF發現這個用戶在我眼裏合法，於是去找其他網元的兄弟去幫忙鑒定。鑒定什麽呢?</p>
<p>SIM卡製造的過程中，每個卡都是有特殊Key值和OP值，核心網需要去鑒權UE的號碼和SIM卡中的值是否對應。</p>
<p>5G裏鑒權的網元是AUSF， AMF會根據SUPI或者SUCI去找對應的AUSF, 而且找的過程還很神秘， 要經過一個中間人NRF。</p>
<p>這個NRF好比是黑道上的綫人，不去直接參與業務交易，但是他手裏有各個大佬的聯絡方式，後面的AMF找UDM,找SMF等等，都要先聯係他。於是AMF通過NRF找到了AUSF。</p>
<h3 id="9-AMF看完消息之後，通過SBI接口協議把一些有價值的内容給到AUSF"><a href="#9-AMF看完消息之後，通過SBI接口協議把一些有價值的内容給到AUSF" class="headerlink" title="9. AMF看完消息之後，通過SBI接口協議把一些有價值的内容給到AUSF."></a>9. AMF看完消息之後，通過SBI接口協議把一些有價值的内容給到AUSF.</h3><p>5G鑒權的詳細過程希望日後專門可以寫一寫，這裏就略過. 先假裝AUSF完成了對UE的鑒權。</p>
<h3 id="10-Conditional-收到鑒權消息后-當前AMF如果同意辦理UE業務，則會通知到舊的AMF。"><a href="#10-Conditional-收到鑒權消息后-當前AMF如果同意辦理UE業務，則會通知到舊的AMF。" class="headerlink" title="10. [Conditional]收到鑒權消息后, 當前AMF如果同意辦理UE業務，則會通知到舊的AMF。"></a>10. [Conditional]收到鑒權消息后, 當前AMF如果同意辦理UE業務，則會通知到舊的AMF。</h3><h3 id="11-Conditional-如果UE的PEI到當前步驟沒有從舊的AMF或者自身携帶的消息中獲得，AMF就不樂意，需要找UE要PEI的信息。"><a href="#11-Conditional-如果UE的PEI到當前步驟沒有從舊的AMF或者自身携帶的消息中獲得，AMF就不樂意，需要找UE要PEI的信息。" class="headerlink" title="11. [Conditional]如果UE的PEI到當前步驟沒有從舊的AMF或者自身携帶的消息中獲得，AMF就不樂意，需要找UE要PEI的信息。"></a>11. [Conditional]如果UE的PEI到當前步驟沒有從舊的AMF或者自身携帶的消息中獲得，AMF就不樂意，需要找UE要PEI的信息。</h3><h3 id="12-Optionally-看各大廠家怎麽設定了-如果需要進行PEI的check-就加上這一次交互。"><a href="#12-Optionally-看各大廠家怎麽設定了-如果需要進行PEI的check-就加上這一次交互。" class="headerlink" title="12. [Optionally]看各大廠家怎麽設定了,如果需要進行PEI的check,就加上這一次交互。"></a>12. [Optionally]看各大廠家怎麽設定了,如果需要進行PEI的check,就加上這一次交互。</h3><h3 id="13-14-AUSF告訴AMF這個合法之後，AMF還要去讓核心網其他的兄弟看看其他的信息。"><a href="#13-14-AUSF告訴AMF這個合法之後，AMF還要去讓核心網其他的兄弟看看其他的信息。" class="headerlink" title="13-14. AUSF告訴AMF這個合法之後，AMF還要去讓核心網其他的兄弟看看其他的信息。"></a>13-14. AUSF告訴AMF這個合法之後，AMF還要去讓核心網其他的兄弟看看其他的信息。</h3><p>這裏就又麻煩NRF去找一個叫UDM的網元，UDM後端連著一個數據庫UDR，裏面有一個小本本，記錄這UE的簽約信息。包含UE簽約速率，切片信息，APN信息等。</p>
<p>比如AMF通過消息找UDM后發現UE簽約的切片是sd 1 sst 1，結果AMF一看你這UE帶上來的怎麽是sd 1 sst 100。即使UE SIM鑒權通過，也會因爲簽約信息被拒絕。</p>
<p>再比如，因爲AMF訂閲了UDM，那麽當我兒子天天用手機打游戲，不好好學習時，我去營業廳把這個卡簽約的internet APN給刪掉。這個時候UDM就通過Notify，告訴AMF，這個手機的簽約不再有這個APN，之後UE則無法通過這個APN注冊。</p>
<h3 id="15-16-Optionally-同樣看各大廠家怎麽設定。-如果需要AMF去找PCF獲取介入策略，就再麻煩一下NRF。"><a href="#15-16-Optionally-同樣看各大廠家怎麽設定。-如果需要AMF去找PCF獲取介入策略，就再麻煩一下NRF。" class="headerlink" title="15-16. [Optionally]同樣看各大廠家怎麽設定。 如果需要AMF去找PCF獲取介入策略，就再麻煩一下NRF。"></a>15-16. [Optionally]同樣看各大廠家怎麽設定。 如果需要AMF去找PCF獲取介入策略，就再麻煩一下NRF。</h3><h3 id="17-Conditional-簽約驗證完成后，AMF檢測到UE相關信息在SMF上時則會觸發。"><a href="#17-Conditional-簽約驗證完成后，AMF檢測到UE相關信息在SMF上時則會觸發。" class="headerlink" title="17. [Conditional]簽約驗證完成后，AMF檢測到UE相關信息在SMF上時則會觸發。"></a>17. [Conditional]簽約驗證完成后，AMF檢測到UE相關信息在SMF上時則會觸發。</h3><p>當step1,中消息體携帶List Of PDU Sessions To Be Activated時，AMF會發送Nsmf_PDUSession_UpdateSMContext給SMF去激活會話。</p>
<h3 id="18-19-Conditional-當存在舊的AMF告訴當前AMF-UE是通過Non-3GPP接入方式即N3IWF時，并且同一PLMN下，當前AMF觸發該流程。"><a href="#18-19-Conditional-當存在舊的AMF告訴當前AMF-UE是通過Non-3GPP接入方式即N3IWF時，并且同一PLMN下，當前AMF觸發該流程。" class="headerlink" title="18-19. [Conditional]當存在舊的AMF告訴當前AMF UE是通過Non-3GPP接入方式即N3IWF時，并且同一PLMN下，當前AMF觸發該流程。"></a>18-19. [Conditional]當存在舊的AMF告訴當前AMF UE是通過Non-3GPP接入方式即N3IWF時，并且同一PLMN下，當前AMF觸發該流程。</h3><h3 id="19a-b-c-Conditional-如果觸發了18-19，説明UE通過Non-3GPP接入，需要再次訂閲UDM，修改接入類型。"><a href="#19a-b-c-Conditional-如果觸發了18-19，説明UE通過Non-3GPP接入，需要再次訂閲UDM，修改接入類型。" class="headerlink" title="19a.b.c. [Conditional]如果觸發了18-19，説明UE通過Non-3GPP接入，需要再次訂閲UDM，修改接入類型。"></a>19a.b.c. [Conditional]如果觸發了18-19，説明UE通過Non-3GPP接入，需要再次訂閲UDM，修改接入類型。</h3><h3 id="21-經過這一系列的交接，AMF認可了這個UE，於是告訴UE-你的注冊請求，我接受了"><a href="#21-經過這一系列的交接，AMF認可了這個UE，於是告訴UE-你的注冊請求，我接受了" class="headerlink" title="21. 經過這一系列的交接，AMF認可了這個UE，於是告訴UE,你的注冊請求，我接受了!"></a>21. 經過這一系列的交接，AMF認可了這個UE，於是告訴UE,你的注冊請求，我接受了!</h3><p>同時下發了一些參數同step1 呼應。 下面參數截于23.502 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">5G-GUTI, Registration Area, Mobility restrictions, PDU Session status, </span><br><span class="line">Allowed NSSAI, [Mapping Of Allowed NSSAI], [Configured NSSAI <span class="keyword">for</span> the Serving PLMN], [Mapping Of Configured NSSAI], [rejected S-NSSAIs], Periodic Registration Update timer, LADN Information and accepted MICO mode, IMS Voice over PS session supported Indication, </span><br><span class="line">Emergency Service Support indicator, Accepted DRX parameters, Network support of Interworking without N26, Access Stratum Connection Establishment NSSAI Inclusion Mode, Network Slicing Subscription Change Indication, Operator-defined access category definitions,</span><br><span class="line">[List of equivalent PLMNs]). The Allowed NSSAI <span class="keyword">for</span> the Access Type <span class="keyword">for</span> the UE is included <span class="keyword">in</span> the N2 message carrying the Registration Accept message.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="22-UE回復AMF，説明注冊完成，謝謝你"><a href="#22-UE回復AMF，説明注冊完成，謝謝你" class="headerlink" title="22. UE回復AMF，説明注冊完成，謝謝你!"></a>22. UE回復AMF，説明注冊完成，謝謝你!</h3>]]></content>
      <tags>
        <tag>5G</tag>
      </tags>
  </entry>
  <entry>
    <title>MACVlAN + OVS</title>
    <url>/2021/12/24/MacValn-OVS/</url>
    <content><![CDATA[<h2 id="Backgroud"><a href="#Backgroud" class="headerlink" title="Backgroud"></a>Backgroud</h2><p>I used to build an openstack env, and when start to learn K8s, i create a K8s cluster base on openstack.</p>
<p>Recently i deployed a kind of pods using MACVALN network to communicate other pods, and i confused how the MACVLAN + OVS works.</p>
<p>Then i try to figure how the message flow goes. This blog will share what i find as a reference.</p>
<span id="more"></span>

<h2 id="MACVLAN-Concept"><a href="#MACVLAN-Concept" class="headerlink" title="MACVLAN Concept"></a>MACVLAN Concept</h2><p>MACVLAN as a CNI plugin use on the K8s, on my point it’s main function is net interface virtualization to make one net interface act as few net interfaces.</p>
<p>In my case, the pod has eth0 and eth1, i set the eth1 to use MACVLAN tech. Then i will have eth1.xx1, eth1.xx2 interface to work. These interfaces were divided into different vlan and interface ip.</p>
<h2 id="MACVLAN-Understanding"><a href="#MACVLAN-Understanding" class="headerlink" title="MACVLAN Understanding"></a>MACVLAN Understanding</h2><p>After pod Running, login the the pod check the eth1 driver, should be MACVLAN</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash-4.4<span class="comment"># ethtool -i eth1    </span></span><br><span class="line">driver: macvlan</span><br><span class="line">version: 0.1</span><br><span class="line">firmware-version: </span><br><span class="line">bus-info: </span><br><span class="line">supports-statistics: no</span><br><span class="line">supports-test: no</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: no</span><br></pre></td></tr></table></figure>

<p>Check the net interface detail, will find fews named like eth1.xxx. The xxx is same as VLAN num and the subnet created before the node created. These interface are the virtualization interfaces and using the same MAC address of eth1.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash-4.4<span class="comment"># ip a </span></span><br><span class="line">7: eth1@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 2090 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 72:<span class="built_in">fc</span>:af:9b:f0:82 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::76fa:affc:fe7c:f082/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: eth1.200@eth1: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 2090 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 72:<span class="built_in">fc</span>:af:9b:f0:82 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 178.27.32.91/25 brd 178.27.32.127 scope global eth1.200</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::76fa:affc:fe7c:f082/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: eth1.201@eth1: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 2090 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 72:<span class="built_in">fc</span>:af:9b:f0:82 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 178.27.26.91/25 brd 178.27.26.127 scope global eth1.201</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::76fa:affc:fe7c:f082/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>Due to MACVLAN belongs to external network CNI and has the unique namespace, we can find the relation between pod net interface and node interface.</p>
<p>Through the output above, we can see the pod eth1 link-netnsid is 0. Using the ip netns list can see the netnsid info on the node.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node-1<span class="comment"># ip netns list </span></span><br><span class="line">cni-f667d2d0-f5a8-0fb3-345f-bc99a6b4ef30 (id: 0)</span><br><span class="line">cni-f667d2d0-f5a8-0fb3-345f-bcasdcse2dd0 (id: 1)</span><br><span class="line"></span><br><span class="line">node-1<span class="comment"># ip a | grep -B 1 cni-f667d2d0-f5a8-0fb3-345f-bc99a6b4ef30</span></span><br><span class="line">22: calid4101c0e062@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 2070 qdisc noqueue state UP group default </span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-f667d2d0-f5a8-0fb3-345f-bc99a6b4ef30</span><br></pre></td></tr></table></figure>

<p>So far we can assume the pod can send the message out from the MACVLAN interface to the node device calid4101c0e062, the next question is how the node pass message to external physical router.</p>
<h2 id="OVS-Concept"><a href="#OVS-Concept" class="headerlink" title="OVS Concept"></a>OVS Concept</h2><p>OVS means Open vSwitch which can operate both as a soft switch running within the hypervisor, and as the control stack for switching.</p>
<p>As i understand, all the VM deployed will connect to the OVS, and the OVS will manage the massive VM’s interface aiming to forward the message.</p>
<p>Then i found few command to help me understand and try to combine with MACVLAN.</p>
<h2 id="OVS-Understanding"><a href="#OVS-Understanding" class="headerlink" title="OVS Understanding"></a>OVS Understanding</h2><p>When we talk about MACVLAN, the virtualization net interface will bind different VLAN and the VLAN subnet need create before the node create.</p>
<p>Base on this, we can try to find which port go through the VLAN.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openstack-1<span class="comment"># neutron port-list  | grep node-1</span></span><br><span class="line">| cceab3c1-77dd-499d-a1d5-ce12233vef60 | node-1-port-1        | 891929b8ecec48279ec8e72ba1233bde | fa:16:3c:1e:d4:c1 </span><br><span class="line"></span><br><span class="line">openstack-1<span class="comment"># openstack network trunk show node-1-trunk-port-1</span></span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| Field           | Value                                                                                            |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| admin_state_up  | UP                                                                                               |</span><br><span class="line">| created_at      |                                                                                                  |</span><br><span class="line">| description     |                                                                                                  |</span><br><span class="line">| id              | acd37579-8ebb-48db-95d3-79dd23026488                                                             |</span><br><span class="line">| name            | node-1-trunk-port-1                                                                              |</span><br><span class="line">| port_id         | cceab3c1-77dd-499d-a1d5-ce12233vef60                                                             |</span><br><span class="line">| revision_number | 4                                                                                                |</span><br><span class="line">| status          | ACTIVE                                                                                           |</span><br><span class="line">| sub_ports       | port_id=<span class="string">&#x27;6d9aa1ce-14ce-4d14-b9c7-a324a01b544d&#x27;</span>, segmentation_id=<span class="string">&#x27;201&#x27;</span>, segmentation_type=<span class="string">&#x27;vlan&#x27;</span> |</span><br><span class="line">|                 | port_id=<span class="string">&#x27;4c5fb20a-149e-4ba9-aaf8-f6aes12d7b7f&#x27;</span>, segmentation_id=<span class="string">&#x27;200&#x27;</span>, segmentation_type=<span class="string">&#x27;vlan&#x27;</span> |</span><br></pre></td></tr></table></figure>

<p>The cceab3c1-77dd-499d-a1d5-ce12233vef60 is the port id, if all VM connect to the OVS, we must can find this id on OVS.</p>
<p>Login in the compute which one deployed the node.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">compute-1<span class="comment"># ovs-vsctl list Interface  | grep cceab3c1-77dd-499d-a1d5-ce12233vef60</span></span><br><span class="line">external_ids        : &#123;attached-mac=<span class="string">&quot;fa:16:3c:1e:d4:c1&quot;</span>, iface-id=<span class="string">&quot;cceab3c1-77dd-499d-a1d5-ce12233vef60&quot;</span>, iface-status=active, vm-uuid=<span class="string">&quot;e5514f47-936d-4fd4-b2e8-dasd31a8942f&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>We can see the MAC address is same as the result neutron port-list. Then let us find more info about the interface.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">compute-1<span class="comment"># ovs-vsctl list Interface | grep -A 15 cceab3c1-77dd-499d-a1d5-ce12233vef60</span></span><br><span class="line">external_ids        : &#123;attached-mac=<span class="string">&quot;fa:16:3c:1e:d4:c1&quot;</span>, iface-id=<span class="string">&quot;cceab3c1-77dd-499d-a1d5-ce12233vef60&quot;</span>, iface-status=active, vm-uuid=<span class="string">&quot;e5514f47-936d-4fd4-b2e8-dasd31a8942f&quot;</span>&#125;</span><br><span class="line">ifindex             : 7898202</span><br><span class="line">ingress_policing_burst: 0</span><br><span class="line">ingress_policing_rate: 0</span><br><span class="line">lacp_current        : []</span><br><span class="line">link_resets         : 0</span><br><span class="line">link_speed          : []</span><br><span class="line">link_state          : up</span><br><span class="line">lldp                : &#123;&#125;</span><br><span class="line">mac                 : []</span><br><span class="line">mtu                 : 2090</span><br><span class="line">mtu_request         : 2090</span><br><span class="line">name                : <span class="string">&quot;vhuaaeab3c1-34&quot;</span></span><br><span class="line"></span><br><span class="line">compute-1<span class="comment"># ovs-vsctl list Port  | grep -B 15 vhuaaeab3c1-34</span></span><br><span class="line">_uuid               : 4edf0fc5-5ccf-44c4-b5f4-0fdaeds12e1b</span><br><span class="line">bond_active_slave   : []</span><br><span class="line">bond_downdelay      : 0</span><br><span class="line">bond_fake_iface     : <span class="literal">false</span></span><br><span class="line">bond_mode           : []</span><br><span class="line">bond_updelay        : 0</span><br><span class="line">cvlans              : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">fake_bridge         : <span class="literal">false</span></span><br><span class="line">interfaces          : [ebc0b72a-132b-4a56-9269-3ebaec372a8d]</span><br><span class="line">lacp                : []</span><br><span class="line">mac                 : []</span><br><span class="line">name                : <span class="string">&quot;vhuaaeab3c1-34&quot;</span></span><br><span class="line"></span><br><span class="line">compute-1<span class="comment">#  ovs-vsctl list Bridge  | grep -B 20 4edf0fc5-5ccf-44c4-b5f4-0fdaeds12e1b</span></span><br><span class="line">_uuid               : fc94fe9c-e98f-4ca2-9e87-0ab347e4d980</span><br><span class="line">auto_attach         : []</span><br><span class="line">controller          : [d2e2a027-e3a3-4c36-b63e-7a2a61f60f77]</span><br><span class="line">datapath_id         : <span class="string">&quot;00009efefca24c&quot;</span></span><br><span class="line">datapath_type       : netdev</span><br><span class="line">datapath_version    : <span class="string">&quot;&lt;built-in&gt;&quot;</span></span><br><span class="line">external_ids        : &#123;flow-restore=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">fail_mode           : secure</span><br><span class="line">flood_vlans         : []</span><br><span class="line">flow_tables         : &#123;&#125;</span><br><span class="line">ipfix               : []</span><br><span class="line">mcast_snooping_enable: <span class="literal">false</span></span><br><span class="line">mirrors             : []</span><br><span class="line">name                : br-int</span><br><span class="line">netflow             : []</span><br><span class="line">other_config        : &#123;disable-in-band=<span class="string">&quot;true&quot;</span>, dp-desc=<span class="string">&quot;compute-1&quot;</span>&#125;</span><br><span class="line">ports               : [97d556dc-ae81-49e2-a6ac-e56se122f733, 9dc93112-f63d-4ad3-9b56-b0a97a3425a7, 4edf0fc5-5ccf-44c4-b5f4-0fdaeds12e1b]</span><br></pre></td></tr></table></figure>

<p>After list bridge, i see a familiar name br-int and type is netdev. When i type ip a, i see the br-int as well. The first thought is the message will go out from this netdev. The second thought is how i capture the OVS flow?</p>
<p>Use below command to show the bridge flow.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ovs-appctl dpif/dump-flows  br-int </span><br></pre></td></tr></table></figure>
<p>if we grep the MACVLAN net interface MAC address, we can see the content. And if Openstack use the VXLAN as the flow way, we can see the VNI id as well.</p>
]]></content>
      <categories>
        <category>Cloud</category>
      </categories>
      <tags>
        <tag>K8s</tag>
        <tag>Openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Create-blog</title>
    <url>/2021/12/20/create-blog/</url>
    <content><![CDATA[<h2 id="Backgroud"><a href="#Backgroud" class="headerlink" title="Backgroud"></a>Backgroud</h2><p>Want to record something i learn from my job.</p>
<h2 id="How-do-i-start-a-blog"><a href="#How-do-i-start-a-blog" class="headerlink" title="How do i start a blog"></a>How do i start a blog</h2><span id="more"></span>

<h3 id="Install-Git-bash-and-NodeJs-on-Win"><a href="#Install-Git-bash-and-NodeJs-on-Win" class="headerlink" title="Install Git bash and NodeJs on Win"></a>Install Git bash and NodeJs on Win</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://git-scm.com/download/win</span><br><span class="line">https://nodejs.org/en/download/</span><br></pre></td></tr></table></figure>
<p>Keep Moving with Next !</p>
<h3 id="Using-Hexo-create-local-blog"><a href="#Using-Hexo-create-local-blog" class="headerlink" title="Using Hexo create local blog"></a>Using Hexo create local blog</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir blog</span><br><span class="line">$ <span class="built_in">cd</span> blog</span><br><span class="line">$ npm install -g hexo-cli</span><br><span class="line">$ hexo init</span><br><span class="line">$ hexo s</span><br></pre></td></tr></table></figure>
<p>Call view the Hexo on localhost !</p>
<h3 id="Set-Git-info-and-copy-SSH-Key-to-GitHub"><a href="#Set-Git-info-and-copy-SSH-Key-to-GitHub" class="headerlink" title="Set Git info and copy SSH Key to GitHub"></a>Set Git info and copy SSH Key to GitHub</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Firstlly, need create a Github account!</span><br><span class="line"></span><br><span class="line">$ git config --global user.name=<span class="string">&quot;user.name&quot;</span></span><br><span class="line">$ git config --global user.email=<span class="string">&quot;mail.address&quot;</span></span><br><span class="line">$ git config --global http.sslVerify <span class="string">&quot;false&quot;</span></span><br><span class="line">$ ssh-keygen -t rsa -C <span class="string">&quot;mail.address&quot;</span></span><br><span class="line"></span><br><span class="line">Create a SSH Key on Github and copy the generated key into.</span><br></pre></td></tr></table></figure>
<p>Can ssh <a href="mailto:&#103;&#105;&#x74;&#64;&#103;&#105;&#116;&#104;&#x75;&#x62;&#46;&#99;&#x6f;&#109;">&#103;&#105;&#x74;&#64;&#103;&#105;&#116;&#104;&#x75;&#x62;&#46;&#99;&#x6f;&#109;</a> !</p>
<h3 id="Upload-local-blog-to-remote-sites"><a href="#Upload-local-blog-to-remote-sites" class="headerlink" title="Upload local blog to remote sites"></a>Upload local blog to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br><span class="line"></span><br><span class="line">Edit the _config.yml under blog/ , change deploy to below:</span><br><span class="line"></span><br><span class="line"> deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repository: <span class="string">&#x27;Self Repository URL&#x27;</span></span><br><span class="line">  branch: main</span><br><span class="line"></span><br><span class="line">$ hexo d </span><br></pre></td></tr></table></figure>

<p>Check your blow using the pages address which find under setting !</p>
<p>Note: Meet the jekyll failed with theme not found, install the ruby to troubleshooter. And situation become more trouble, the faster is to delete blog folder and do again above..</p>
]]></content>
  </entry>
  <entry>
    <title>Trace all node</title>
    <url>/2021/12/25/Trace-all-node/</url>
    <content><![CDATA[<h2 id="Backgroud"><a href="#Backgroud" class="headerlink" title="Backgroud"></a>Backgroud</h2><p>Due to K8s cluster has daemonset pod, if want to capture all node traffic, need login each node and tcpdump.</p>
<p>Here is a shell script to solve this. </p>
<h2 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h2><span id="more"></span>


<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#path to store captures</span></span><br><span class="line">storePath=$(readlink -f <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">nodes[1]=<span class="string">&#x27;192.168.12.30&#x27;</span></span><br><span class="line">nodes[2]=<span class="string">&#x27;192.168.12.25&#x27;</span></span><br><span class="line">nodes[3]=<span class="string">&#x27;192.168.12.10&#x27;</span></span><br><span class="line">nodes[4]=<span class="string">&#x27;192.168.12.19&#x27;</span></span><br><span class="line">nodes[5]=<span class="string">&#x27;192.168.12.17&#x27;</span></span><br><span class="line">nodes[6]=<span class="string">&#x27;192.168.12.24&#x27;</span></span><br><span class="line">nodes[7]=<span class="string">&#x27;192.168.12.21&#x27;</span></span><br><span class="line">nodes[8]=<span class="string">&#x27;192.168.12.31&#x27;</span></span><br><span class="line">nodes[9]=<span class="string">&#x27;192.168.12.8&#x27;</span></span><br><span class="line">nodes[10]=<span class="string">&#x27;192.168.12.12&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;start&quot;</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;nodes[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  ssh <span class="variable">$p</span> sudo tcpdump -s0 -i eth1 net 192.168.12.0/24 -w capture-<span class="variable">$p</span>.pcap -G 900 -W 1  &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;tcpdump started on <span class="variable">$p</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;stop&quot;</span> ];</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;nodes[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">                tcpdumpPID=`ssh <span class="variable">$p</span> ps aux | grep <span class="variable">$p</span> | grep tcpdump | grep -v grep  | awk <span class="string">&#x27;(NR==2) &#123;print $2&#125;&#x27;</span>`</span><br><span class="line">                ssh <span class="variable">$p</span> sudo <span class="built_in">kill</span> <span class="variable">$tcpdumpPID</span></span><br><span class="line">                scp yanzu@<span class="variable">$p</span>:/home/yanzu/capture-<span class="variable">$p</span>.pcap <span class="variable">$storePath</span></span><br><span class="line">                ssh <span class="variable">$p</span> sudo rm /home/yanzu/capture-<span class="variable">$p</span>.pcap</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;tcpdump is stopped on <span class="variable">$p</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;The usage is ./tcpdumpTraces.sh &lt;start/stop&gt;&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>K8s</tag>
        <tag>Shell</tag>
      </tags>
  </entry>
</search>
