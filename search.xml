<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>MACVlAN + OVS</title>
    <url>/2021/12/24/MacValn-OVS/</url>
    <content><![CDATA[<h2 id="Backgroud"><a href="#Backgroud" class="headerlink" title="Backgroud"></a>Backgroud</h2><p>I used to build an openstack env, and when start to learn K8s, i create a K8s cluster base on openstack.</p>
<p>Recently i deployed a kind of pods using MACVALN network to communicate other pods, and i confused how the MACVLAN + OVS works.</p>
<p>Then i try to figure how the message flow goes. This blog will share what i find as a reference.</p>
<span id="more"></span>

<h2 id="MACVLAN-Concept"><a href="#MACVLAN-Concept" class="headerlink" title="MACVLAN Concept"></a>MACVLAN Concept</h2><p>MACVLAN as a CNI plugin use on the K8s, on my point it’s main function is net interface virtualization to make one net interface act as few net interfaces.</p>
<p>In my case, the pod has eth0 and eth1, i set the eth1 to use MACVLAN tech. Then i will have eth1.xx1, eth1.xx2 interface to work. These interfaces were divided into different vlan and interface ip.</p>
<h2 id="MACVLAN-Understanding"><a href="#MACVLAN-Understanding" class="headerlink" title="MACVLAN Understanding"></a>MACVLAN Understanding</h2><p>After pod Running, login the the pod check the eth1 driver, should be MACVLAN</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash-4.4<span class="comment"># ethtool -i eth1    </span></span><br><span class="line">driver: macvlan</span><br><span class="line">version: 0.1</span><br><span class="line">firmware-version: </span><br><span class="line">bus-info: </span><br><span class="line">supports-statistics: no</span><br><span class="line">supports-test: no</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: no</span><br></pre></td></tr></table></figure>

<p>Check the net interface detail, will find fews named like eth1.xxx. The xxx is same as VLAN num and the subnet created before the node created. These interface are the virtualization interfaces and using the same MAC address of eth1.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash-4.4<span class="comment"># ip a </span></span><br><span class="line">7: eth1@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 2090 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 72:<span class="built_in">fc</span>:af:9b:f0:82 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::76fa:affc:fe7c:f082/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: eth1.200@eth1: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 2090 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 72:<span class="built_in">fc</span>:af:9b:f0:82 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 178.27.32.91/25 brd 178.27.32.127 scope global eth1.200</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::76fa:affc:fe7c:f082/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: eth1.201@eth1: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 2090 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 72:<span class="built_in">fc</span>:af:9b:f0:82 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 178.27.26.91/25 brd 178.27.26.127 scope global eth1.201</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::76fa:affc:fe7c:f082/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>Due to MACVLAN belongs to external network CNI and has the unique namespace, we can find the relation between pod net interface and node interface.</p>
<p>Through the output above, we can see the pod eth1 link-netnsid is 0. Using the ip netns list can see the netnsid info on the node.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node-1<span class="comment"># ip netns list </span></span><br><span class="line">cni-f667d2d0-f5a8-0fb3-345f-bc99a6b4ef30 (id: 0)</span><br><span class="line">cni-f667d2d0-f5a8-0fb3-345f-bcasdcse2dd0 (id: 1)</span><br><span class="line"></span><br><span class="line">node-1<span class="comment"># ip a | grep -B 1 cni-f667d2d0-f5a8-0fb3-345f-bc99a6b4ef30</span></span><br><span class="line">22: calid4101c0e062@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 2070 qdisc noqueue state UP group default </span><br><span class="line">    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-f667d2d0-f5a8-0fb3-345f-bc99a6b4ef30</span><br></pre></td></tr></table></figure>

<p>So far we can assume the pod can send the message out from the MACVLAN interface to the node device calid4101c0e062, the next question is how the node pass message to external physical router.</p>
<h2 id="OVS-Concept"><a href="#OVS-Concept" class="headerlink" title="OVS Concept"></a>OVS Concept</h2><p>OVS means Open vSwitch which can operate both as a soft switch running within the hypervisor, and as the control stack for switching.</p>
<p>As i understand, all the VM deployed will connect to the OVS, and the OVS will manage the massive VM’s interface aiming to forward the message.</p>
<p>Then i found few command to help me understand and try to combine with MACVLAN.</p>
<h2 id="OVS-Understanding"><a href="#OVS-Understanding" class="headerlink" title="OVS Understanding"></a>OVS Understanding</h2><p>When we talk about MACVLAN, the virtualization net interface will bind different VLAN and the VLAN subnet need create before the node create.</p>
<p>Base on this, we can try to find which port go through the VLAN.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openstack-1<span class="comment"># neutron port-list  | grep node-1</span></span><br><span class="line">| cceab3c1-77dd-499d-a1d5-ce12233vef60 | node-1-port-1        | 891929b8ecec48279ec8e72ba1233bde | fa:16:3c:1e:d4:c1 </span><br><span class="line"></span><br><span class="line">openstack-1<span class="comment"># openstack network trunk show node-1-trunk-port-1</span></span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| Field           | Value                                                                                            |</span><br><span class="line">+-----------------+--------------------------------------------------------------------------------------------------+</span><br><span class="line">| admin_state_up  | UP                                                                                               |</span><br><span class="line">| created_at      |                                                                                                  |</span><br><span class="line">| description     |                                                                                                  |</span><br><span class="line">| id              | acd37579-8ebb-48db-95d3-79dd23026488                                                             |</span><br><span class="line">| name            | node-1-trunk-port-1                                                                              |</span><br><span class="line">| port_id         | cceab3c1-77dd-499d-a1d5-ce12233vef60                                                             |</span><br><span class="line">| revision_number | 4                                                                                                |</span><br><span class="line">| status          | ACTIVE                                                                                           |</span><br><span class="line">| sub_ports       | port_id=<span class="string">&#x27;6d9aa1ce-14ce-4d14-b9c7-a324a01b544d&#x27;</span>, segmentation_id=<span class="string">&#x27;201&#x27;</span>, segmentation_type=<span class="string">&#x27;vlan&#x27;</span> |</span><br><span class="line">|                 | port_id=<span class="string">&#x27;4c5fb20a-149e-4ba9-aaf8-f6aes12d7b7f&#x27;</span>, segmentation_id=<span class="string">&#x27;200&#x27;</span>, segmentation_type=<span class="string">&#x27;vlan&#x27;</span> |</span><br></pre></td></tr></table></figure>

<p>The cceab3c1-77dd-499d-a1d5-ce12233vef60 is the port id, if all VM connect to the OVS, we must can find this id on OVS.</p>
<p>Login in the compute which one deployed the node.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">compute-1<span class="comment"># ovs-vsctl list Interface  | grep cceab3c1-77dd-499d-a1d5-ce12233vef60</span></span><br><span class="line">external_ids        : &#123;attached-mac=<span class="string">&quot;fa:16:3c:1e:d4:c1&quot;</span>, iface-id=<span class="string">&quot;cceab3c1-77dd-499d-a1d5-ce12233vef60&quot;</span>, iface-status=active, vm-uuid=<span class="string">&quot;e5514f47-936d-4fd4-b2e8-dasd31a8942f&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>We can see the MAC address is same as the result neutron port-list. Then let us find more info about the interface.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">compute-1<span class="comment"># ovs-vsctl list Interface | grep -A 15 cceab3c1-77dd-499d-a1d5-ce12233vef60</span></span><br><span class="line">external_ids        : &#123;attached-mac=<span class="string">&quot;fa:16:3c:1e:d4:c1&quot;</span>, iface-id=<span class="string">&quot;cceab3c1-77dd-499d-a1d5-ce12233vef60&quot;</span>, iface-status=active, vm-uuid=<span class="string">&quot;e5514f47-936d-4fd4-b2e8-dasd31a8942f&quot;</span>&#125;</span><br><span class="line">ifindex             : 7898202</span><br><span class="line">ingress_policing_burst: 0</span><br><span class="line">ingress_policing_rate: 0</span><br><span class="line">lacp_current        : []</span><br><span class="line">link_resets         : 0</span><br><span class="line">link_speed          : []</span><br><span class="line">link_state          : up</span><br><span class="line">lldp                : &#123;&#125;</span><br><span class="line">mac                 : []</span><br><span class="line">mtu                 : 2090</span><br><span class="line">mtu_request         : 2090</span><br><span class="line">name                : <span class="string">&quot;vhuaaeab3c1-34&quot;</span></span><br><span class="line"></span><br><span class="line">compute-1<span class="comment"># ovs-vsctl list Port  | grep -B 15 vhuaaeab3c1-34</span></span><br><span class="line">_uuid               : 4edf0fc5-5ccf-44c4-b5f4-0fdaeds12e1b</span><br><span class="line">bond_active_slave   : []</span><br><span class="line">bond_downdelay      : 0</span><br><span class="line">bond_fake_iface     : <span class="literal">false</span></span><br><span class="line">bond_mode           : []</span><br><span class="line">bond_updelay        : 0</span><br><span class="line">cvlans              : []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">fake_bridge         : <span class="literal">false</span></span><br><span class="line">interfaces          : [ebc0b72a-132b-4a56-9269-3ebaec372a8d]</span><br><span class="line">lacp                : []</span><br><span class="line">mac                 : []</span><br><span class="line">name                : <span class="string">&quot;vhuaaeab3c1-34&quot;</span></span><br><span class="line"></span><br><span class="line">compute-1<span class="comment">#  ovs-vsctl list Bridge  | grep -B 20 4edf0fc5-5ccf-44c4-b5f4-0fdaeds12e1b</span></span><br><span class="line">_uuid               : fc94fe9c-e98f-4ca2-9e87-0ab347e4d980</span><br><span class="line">auto_attach         : []</span><br><span class="line">controller          : [d2e2a027-e3a3-4c36-b63e-7a2a61f60f77]</span><br><span class="line">datapath_id         : <span class="string">&quot;00009efefca24c&quot;</span></span><br><span class="line">datapath_type       : netdev</span><br><span class="line">datapath_version    : <span class="string">&quot;&lt;built-in&gt;&quot;</span></span><br><span class="line">external_ids        : &#123;flow-restore=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">fail_mode           : secure</span><br><span class="line">flood_vlans         : []</span><br><span class="line">flow_tables         : &#123;&#125;</span><br><span class="line">ipfix               : []</span><br><span class="line">mcast_snooping_enable: <span class="literal">false</span></span><br><span class="line">mirrors             : []</span><br><span class="line">name                : br-int</span><br><span class="line">netflow             : []</span><br><span class="line">other_config        : &#123;disable-in-band=<span class="string">&quot;true&quot;</span>, dp-desc=<span class="string">&quot;compute-1&quot;</span>&#125;</span><br><span class="line">ports               : [97d556dc-ae81-49e2-a6ac-e56se122f733, 9dc93112-f63d-4ad3-9b56-b0a97a3425a7, 4edf0fc5-5ccf-44c4-b5f4-0fdaeds12e1b]</span><br></pre></td></tr></table></figure>

<p>After list bridge, i see a familiar name br-int and type is netdev. When i type ip a, i see the br-int as well. The first thought is the message will go out from this netdev. The second thought is how i capture the OVS flow?</p>
<p>Use below command to show the bridge flow.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ovs-appctl dpif/dump-flows  br-int </span><br></pre></td></tr></table></figure>
<p>if we grep the MACVLAN net interface MAC address, we can see the content. And if Openstack use the VXLAN as the flow way, we can see the VNI id as well.</p>
]]></content>
      <categories>
        <category>Cloud</category>
      </categories>
      <tags>
        <tag>K8s</tag>
        <tag>Openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Create-blog</title>
    <url>/2021/12/20/create-blog/</url>
    <content><![CDATA[<h2 id="Backgroud"><a href="#Backgroud" class="headerlink" title="Backgroud"></a>Backgroud</h2><p>Want to record something i learn from my job.</p>
<h2 id="How-do-i-start-a-blog"><a href="#How-do-i-start-a-blog" class="headerlink" title="How do i start a blog"></a>How do i start a blog</h2><span id="more"></span>

<h3 id="Install-Git-bash-and-NodeJs-on-Win"><a href="#Install-Git-bash-and-NodeJs-on-Win" class="headerlink" title="Install Git bash and NodeJs on Win"></a>Install Git bash and NodeJs on Win</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://git-scm.com/download/win</span><br><span class="line">https://nodejs.org/en/download/</span><br></pre></td></tr></table></figure>
<p>Keep Moving with Next !</p>
<h3 id="Using-Hexo-create-local-blog"><a href="#Using-Hexo-create-local-blog" class="headerlink" title="Using Hexo create local blog"></a>Using Hexo create local blog</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir blog</span><br><span class="line">$ <span class="built_in">cd</span> blog</span><br><span class="line">$ npm install -g hexo-cli</span><br><span class="line">$ hexo init</span><br><span class="line">$ hexo s</span><br></pre></td></tr></table></figure>
<p>Call view the Hexo on localhost !</p>
<h3 id="Set-Git-info-and-copy-SSH-Key-to-GitHub"><a href="#Set-Git-info-and-copy-SSH-Key-to-GitHub" class="headerlink" title="Set Git info and copy SSH Key to GitHub"></a>Set Git info and copy SSH Key to GitHub</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Firstlly, need create a Github account!</span><br><span class="line"></span><br><span class="line">$ git config --global user.name=<span class="string">&quot;user.name&quot;</span></span><br><span class="line">$ git config --global user.email=<span class="string">&quot;mail.address&quot;</span></span><br><span class="line">$ git config --global http.sslVerify <span class="string">&quot;false&quot;</span></span><br><span class="line">$ ssh-keygen -t rsa -C <span class="string">&quot;mail.address&quot;</span></span><br><span class="line"></span><br><span class="line">Create a SSH Key on Github and copy the generated key into.</span><br></pre></td></tr></table></figure>
<p>Can ssh <a href="mailto:&#x67;&#105;&#x74;&#64;&#103;&#105;&#x74;&#x68;&#x75;&#98;&#46;&#x63;&#111;&#x6d;">&#x67;&#105;&#x74;&#64;&#103;&#105;&#x74;&#x68;&#x75;&#98;&#46;&#x63;&#111;&#x6d;</a> !</p>
<h3 id="Upload-local-blog-to-remote-sites"><a href="#Upload-local-blog-to-remote-sites" class="headerlink" title="Upload local blog to remote sites"></a>Upload local blog to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br><span class="line"></span><br><span class="line">Edit the _config.yml under blog/ , change deploy to below:</span><br><span class="line"></span><br><span class="line"> deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repository: <span class="string">&#x27;Self Repository URL&#x27;</span></span><br><span class="line">  branch: main</span><br><span class="line"></span><br><span class="line">$ hexo d </span><br></pre></td></tr></table></figure>

<p>Check your blow using the pages address which find under setting !</p>
<p>Note: Meet the jekyll failed with theme not found, install the ruby to troubleshooter. And situation become more trouble, the faster is to delete blog folder and do again above..</p>
]]></content>
  </entry>
</search>
